<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>更新情報</title>
<style>
  :root { --gap:12px; --radius:14px; --pad:14px; --max:900px; }
  body { margin:0; background:#ffffff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP",Roboto,Arial,sans-serif; display:flex; justify-content:center; }
  main { width:100%; max-width:var(--max); padding:16px; background:#ffffff; }
  header { display:flex; gap:12px; align-items:center; margin:0 0 12px; flex-wrap:wrap; }
  h1 { margin:0; font-size:20px; font-weight:700; }
  .controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
  .search { padding:8px 10px; border:1px solid #ccc; border-radius:999px; min-width:220px; outline:0; }
  .list { display:grid; grid-template-columns:1fr; gap:var(--gap); }
  .card { background:#fff; border:1px solid #e9e9ec; border-radius:var(--radius); box-shadow:0 4px 16px rgba(0,0,0,.06); padding:var(--pad); }
  .date { font-size:12px; color:#666; margin-bottom:6px; }
  .title { font-size:16px; line-height:1.5; font-weight:700; margin:0; word-break:break-word; }
  .title a { color:#144d8a; text-decoration:none; }
  .title a:hover,.title a:focus { text-decoration:underline; }
  .empty { text-align:center; color:#666; padding:24px; background:#fff; border:1px dashed #ddd; border-radius:var(--radius); }
  .footer { text-align:center; margin-top:16px; }
  .btn { display:inline-block; padding:10px 14px; border-radius:999px; border:1px solid #ccc; background:#fff; text-decoration:none; color:#333; }
  @media (min-width:720px){ .list{ grid-template-columns:1fr 1fr } }
</style>

<main>
  <header>
    <h1>更新情報</h1>
    <div class="controls">
      <input id="q" class="search" type="search" placeholder="キーワード検索（タイトル/URL）">
    </div>
  </header>

  <section id="list" class="list" hidden></section>
  <div id="empty" class="empty" hidden>表示できる更新はありません。</div>
  <div id="more" class="footer" hidden>
    <button id="moreBtn" class="btn" type="button">もっと見る</button>
  </div>
</main>

<script>
/* ==========================
 * 設定：CSVの場所など
 * ========================== */

// ★ あなたがくれたCSV（A:更新日 / B:更新内容 / C:URL）
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRQ0vz79yyWOQ6nSsWfWYGT-ILp1NUGBIH4MYzA_8Hl0DFNrquUerJtZtqhqsPE3-5JhiOFekCIA-QZ/pub?gid=1855337934&single=true&output=csv";

// 初期表示件数 / 「もっと見る」増分
const PAGE_SIZE = 5;

// キャッシュ避け（都度最新を取りたいとき true）
const CACHE_BUST = true;


/* ==========================
 * 実装
 * ========================== */

let allItems = [];     // 全件（{date, text, url}）
let filtered = [];     // 絞り込み後
let shownCount = 0;    // いま画面に出している件数

const sel = id => document.getElementById(id);

async function loadCsv(){
  const url = CSV_URL + (CACHE_BUST ? `&cachebust=${Date.now()}` : "");
  const res = await fetch(url);
  if (!res.ok) throw new Error("CSVの取得に失敗しました");
  const text = await res.text();
  const rows = parseCsv(text);
  if (!rows.length) return [];

  // 先頭行はヘッダー想定（"更新日","更新内容","URL"）
  const body = rows.slice(1);

  // シートが下に追記される運用を想定 → 新しい順に並べ替え（末尾が最新なら reverse）
  body.reverse();

  // A:日付 / B:テキスト / C:URL
  const items = body.map(r => ({
    date: (r[0] || "").trim(),
    text: (r[1] || "").trim(),
    url:  (r[2] || "").trim()
  }));

  return items;
}

function renderNext(){
  const list = sel("list");
  const empty = sel("empty");
  const more = sel("more");

  if (!filtered.length){
    list.hidden = true;
    empty.hidden = false;
    more.hidden = true;
    return;
  }

  const end = Math.min(filtered.length, shownCount + PAGE_SIZE);
  const frag = document.createDocumentFragment();

  for (let i = shownCount; i < end; i++){
    const {date, text, url} = filtered[i];

    const card = document.createElement("article");
    card.className = "card";

    const d = document.createElement("div");
    d.className = "date";
    d.textContent = date;

    const h = document.createElement("h2");
    h.className = "title";
    if (url){
      const a = document.createElement("a");
      a.href = url; a.target = "_blank"; a.rel = "noopener noreferrer";
      a.textContent = text || url;
      h.appendChild(a);
    } else {
      h.textContent = text || "(タイトル未設定)";
    }

    card.append(d, h);
    frag.appendChild(card);
  }

  list.appendChild(frag);
  list.hidden = false;
  empty.hidden = true;

  shownCount = end;
  more.hidden = shownCount >= filtered.length;
}

function applyFilter(q){
  const kw = (q || "").trim().toLowerCase();
  if (!kw){
    filtered = allItems.slice();
  } else {
    filtered = allItems.filter(it =>
      (it.text && it.text.toLowerCase().includes(kw)) ||
      (it.url && it.url.toLowerCase().includes(kw))
    );
  }
  // 再描画
  sel("list").innerHTML = "";
  shownCount = 0;
  renderNext();
}

/* ---------- ユーティリティ ---------- */
// 簡易CSVパーサ（カンマ/改行/ダブルクォート対応）
function parseCsv(s){
  const rows = []; let row = [], cell = "", q = false;
  for (let i=0; i<s.length; i++){
    const c = s[i], n = s[i+1];
    if (q){
      if (c === '"' && n === '"'){ cell += '"'; i++; continue; }
      if (c === '"'){ q = false; continue; }
      cell += c; continue;
    }
    if (c === '"'){ q = true; continue; }
    if (c === ','){ row.push(cell); cell = ""; continue; }
    if (c === '\n'){ row.push(cell); rows.push(row); row = []; cell = ""; continue; }
    cell += c;
  }
  row.push(cell); rows.push(row);
  return rows;
}

/* ---------- 起動 ---------- */
(async function init(){
  try {
    allItems = await loadCsv();
    filtered = allItems.slice();
    renderNext();

    // イベント
    sel("moreBtn").addEventListener("click", renderNext);
    sel("q").addEventListener("input", e => applyFilter(e.target.value));
  } catch (e) {
    console.error(e);
    sel("empty").textContent = "データの読み込みに失敗しました。時間をおいて再度お試しください。";
    sel("empty").hidden = false;
  }
})();
</script>
</html>
